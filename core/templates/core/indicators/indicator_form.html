{% extends 'core/base.html' %}
{% load widget_tweaks %}
{% block title %}{{ title }} - {{ project.name }}{% endblock %}

{% block content %}
<div class="card shadow-sm p-4" style="max-width: 600px; margin: 30px auto;">
  <h2 class="mb-3">{{ title }}</h2>
  <p><strong>Project:</strong> {{ project.name }}</p>

  <form method="post" novalidate id="indicatorForm">
    {% csrf_token %}

    <!-- Year selector for KPI target -->
    <div class="mb-3">
      <label for="id_year" class="form-label">Select Year for Target</label>
      <select name="year" id="id_year" class="form-select {% if form.errors.year %}is-invalid{% endif %}">
        {% for y in years %}
          <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
      {% if form.errors.year %}
        <div class="invalid-feedback">{{ form.errors.year|striptags }}</div>
      {% endif %}
      <div class="form-text">Set the annual target for this KPI (whole numbers only).</div>
    </div>

    <!-- Target input -->
    <div class="mb-3">
      <label for="id_target" class="form-label">Target</label>
      <input type="number"
             name="target"
             id="id_target"
             step="1"
             min="0"
             class="form-control {% if form.errors.target %}is-invalid{% endif %}"
             value="{{ form.initial.target|default_if_none:'' }}">
      {% if form.errors.target %}
        <div class="invalid-feedback">{{ form.errors.target|striptags }}</div>
      {% endif %}
      <div class="form-text">Enter a whole number only (no decimals).</div>
    </div>

    <!-- KPI Name -->
    <div class="mb-3">
      <label for="{{ form.name.id_for_label }}" class="form-label">KPI Name</label>
      {{ form.name|add_class:"form-control" }}
      {% if form.errors.name %}
        <div class="invalid-feedback">{{ form.errors.name|striptags }}</div>
      {% endif %}
    </div>

    <!-- Unit -->
    <div class="mb-3">
      <label for="{{ form.unit.id_for_label }}" class="form-label">Unit</label>
      {{ form.unit|add_class:"form-control" }}
      {% if form.errors.unit %}
        <div class="invalid-feedback">{{ form.errors.unit|striptags }}</div>
      {% endif %}
    </div>

    <!-- Is KPI checkbox -->
    <div class="form-check mb-3">
      {{ form.is_kpi|add_class:"form-check-input" }}
      <label class="form-check-label" for="{{ form.is_kpi.id_for_label }}">Is KPI?</label>
      {% if form.errors.is_kpi %}
        <div class="text-danger small">{{ form.errors.is_kpi|striptags }}</div>
      {% endif %}
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-success">ðŸ’¾ Save</button>
      <a href="{% url 'project_detail' project.pk %}" class="btn btn-secondary">â†© Back</a>
    </div>
  </form>
</div>

<script>
  // Inline validation for whole-number target
  const form = document.getElementById('indicatorForm');
  const targetInput = document.getElementById('id_target');

  function validateTarget() {
    const val = targetInput.value.trim();
    if (val !== '' && (!Number.isInteger(Number(val)) || Number(val) < 0)) {
      targetInput.classList.add('is-invalid');
      return false;
    } else {
      targetInput.classList.remove('is-invalid');
      return true;
    }
  }

  targetInput.addEventListener('input', validateTarget);

  form.addEventListener('submit', function(e) {
    if (!validateTarget()) {
      e.preventDefault();
      alert('Please enter a valid whole number for the target.');
    }
  });
</script>

<style>
  /* Invalid input highlight */
  .is-invalid {
    border-color: #dc3545 !important;
    background-color: #ffe6e6;
  }

  /* Remove spinner arrows in number inputs */
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
  }
  input[type=number] {
      -moz-appearance: textfield;
  }
</style>
{% endblock %}
