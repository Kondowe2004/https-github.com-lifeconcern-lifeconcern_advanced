{% extends "core/base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load custom_tags %}

{% block title %}Reports - Life Concern{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mb-4 text-center text-primary fw-bold">üìä Life Concern Summary Reports</h2>

  <!-- Year Selector -->
  <div class="mb-4 d-flex justify-content-center">
    <form method="get" class="d-flex align-items-center gap-3">
      <label for="year" class="fw-semibold">Select Year:</label>
      <select name="year" id="year" class="form-select" onchange="this.form.submit()">
        {% for y in years %}
          <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </form>
  </div>

  <h4 class="text-center text-secondary mb-4">Displaying Reports for <span class="fw-bold">{{ year }}</span></h4>

  <!-- Table Scrollbars and Pill-card Styling -->
  <style>
    .table-scroll { max-height: 380px; overflow: auto; }
    .table-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
    .table-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,.2); border-radius: 8px; }
    @media (max-width: 576px) { .table-scroll { max-height: 260px; } }

    .pill-card { border-radius: 1rem; border: 1px solid rgba(0,0,0,.05); background-color: #fff; }
    .pill-card .table thead th { background: #e9f5ff; }
    .pill-card .table-striped tbody tr:nth-of-type(odd) { background-color: rgba(0,0,0,.02); }
    .pill-card .table td, .pill-card .table th { vertical-align: middle; }

    .nav-pills .nav-link.active { background-color: #0d6efd !important; color: #fff !important; }
    .nav-pills .nav-link:hover { background-color: #0b5ed7; color: #fff; }
  </style>

<!-- ================= Indicator Drilldown ================= -->
<div class="card mb-4 p-3 shadow-sm">
  <h4 class="text-primary">üéØ Indicator Drilldown</h4>
  <form method="get" class="row mb-3">
    <div class="col-md-6 mb-2">
      <label for="unitSelect" class="form-label">Select Unit</label>
      <select name="unit" id="unitSelect" class="form-select" onchange="this.form.submit()">
        <option value="">-- Choose a Unit --</option>
        {% for unit in units %}
          <option value="{{ unit }}" {% if unit == selected_unit %}selected{% endif %}>{{ unit }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6 mb-2">
      <label for="indicatorSelect" class="form-label">Select Indicator(s)</label>
      <select name="indicators" id="indicatorSelect" class="form-select" multiple size="5" onchange="this.form.submit()">
        {% for indicator in indicators %}
          {% if not selected_unit or indicator.unit == selected_unit %}
            <option value="{{ indicator.id }}" {% if selected_indicators and indicator.id|stringformat:"s" in selected_indicators %}selected{% endif %}>
              {{ indicator.name }}
            </option>
          {% endif %}
        {% endfor %}
      </select>
      <small class="text-muted">Hold Ctrl (Windows) or Cmd (Mac) to select multiple indicators</small>
    </div>
  </form>

  <!-- Chart removed; only table remains -->
  {# <canvas id="indicatorChart" height="80"></canvas> #}

  {% if selected_unit and selected_indicators_data %}
    <div class="table-responsive table-scroll mt-3">
      <table class="table table-sm table-hover table-striped align-middle">
        <thead class="table-light">
          <tr><th>Indicator</th><th class="text-end">Value</th></tr>
        </thead>
        <tbody>
          {% for ind in selected_indicators_data %}
            <tr>
              <td>{{ ind.name }}</td>
              <td class="text-end">{{ ind.value }}</td>
            </tr>
          {% endfor %}
          <tr class="table-secondary fw-bold">
            <td>Overall Total</td>
            <td class="text-end">{{ overall_total }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  {% endif %}
</div>


  <!-- ================= Dashboard Tabs ================= -->
  <ul class="nav nav-pills justify-content-center mb-4 flex-wrap gap-2" id="reportTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active rounded-pill px-4 py-2 shadow-sm" id="ytd-tab" data-bs-toggle="pill" data-bs-target="#ytd" type="button" role="tab">üìä Year-to-Date</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link rounded-pill px-4 py-2 shadow-sm" id="monthly-tab" data-bs-toggle="pill" data-bs-target="#monthly" type="button" role="tab">üìÖ Monthly</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link rounded-pill px-4 py-2 shadow-sm" id="quarterly-tab" data-bs-toggle="pill" data-bs-target="#quarterly" type="button" role="tab">üìä Quarterly</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link rounded-pill px-4 py-2 shadow-sm" id="project-tab" data-bs-toggle="pill" data-bs-target="#project" type="button" role="tab">ü•ß Project Totals</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link rounded-pill px-4 py-2 shadow-sm" id="trends-tab" data-bs-toggle="pill" data-bs-target="#trends" type="button" role="tab">üìå Project Trends</button>
    </li>
  </ul>

  <div class="tab-content" id="reportTabsContent">

<!-- ================= Year-to-Date ================= -->
<div class="tab-pane fade show active" id="ytd" role="tabpanel">
  <div class="card p-3 shadow-sm pill-card">
    <div class="d-flex justify-content-between align-items-center">
      <h4>üìä Year-to-Date Totals</h4>
      <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart('ytdChart')">‚¨áÔ∏è Download</button>
    </div>
    <canvas id="ytdChart" height="600"></canvas>

    <div class="table-responsive table-scroll mt-3">
      <table class="table table-sm table-hover table-striped align-middle">
        <thead class="table-light"><tr><th>Indicator</th><th class="text-end">YTD</th></tr></thead>
        <tbody>
          {% if ytd_indicator_totals %}
            {% for row in ytd_indicator_totals %}
              <tr><td>{{ row.name }}</td><td class="text-end">{{ row.value|default:"0" }}</td></tr>
            {% endfor %}
            <tr class="fw-bold table-secondary"><td>Total</td><td class="text-end">{{ ytd_total|default:"0" }}</td></tr>
          {% else %}
            <tr><td colspan="2" class="text-center text-muted">No YTD data</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if ytd_indicator_totals %}
      <hr class="my-3">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0 text-primary">Per-Indicator YTD Breakdown</h6>
        <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart('ytdIndicatorChart')">‚¨áÔ∏è Download</button>
      </div>
      <canvas id="ytdIndicatorChart" height="500" class="mt-2"></canvas>
      <div class="table-responsive table-scroll mt-3">
        <table class="table table-sm table-hover table-striped align-middle">
          <thead class="table-light"><tr><th>Indicator</th><th class="text-end">YTD</th></tr></thead>
          <tbody>
            {% for row in ytd_indicator_totals %}
              <tr><td>{{ row.name }}</td><td class="text-end">{{ row.value }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>
</div>


<script>
function renderYTDChart(){
  // Build chart data without the overall total
  const ytdLabels = [{% for row in ytd_totals %}{% if not forloop.last %}"{{ row.indicator__name|escapejs }}",{% endif %}{% endfor %}];
  const ytdData = [{% for row in ytd_totals %}{% if not forloop.last %}{{ row.total|default:0|floatformat:"-2" }},{% endif %}{% endfor %}];

  // Main YTD chart
  const ctx = document.getElementById("ytdChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: ytdLabels,
      datasets: [{
        label: "YTD",
        data: ytdData,
        backgroundColor: ytdLabels.map(() => "rgba(75,192,192,0.7)"),
        barPercentage: 0.4,
        categoryPercentage: 0.6
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 800 },
          max: Math.max(...ytdData) + 800
        },
        x: { grid: { display: false } }
      },
      animation: { duration: 1000 }
    }
  });

  // Per-Indicator YTD Breakdown chart (exclude overall total)
  const ctx2 = document.getElementById("ytdIndicatorChart").getContext("2d");
  const breakdownLabels = [{% for row in ytd_indicator_totals %}"{{ row.name|escapejs }}",{% endfor %}];
  const breakdownData = [{% for row in ytd_indicator_totals %}{{ row.value|default:0 }},{% endfor %}];

  new Chart(ctx2, {
    type: "bar",
    data: {
      labels: breakdownLabels,
      datasets: [{
        label: "YTD",
        data: breakdownData,
        backgroundColor: breakdownLabels.map(() => "rgba(54,162,235,0.7)"),
        barPercentage: 0.4,
        categoryPercentage: 0.6
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
      scales: { 
        y: { beginAtZero: true, ticks: { stepSize: 800 } },
        x: { grid: { display: false } }
      },
      animation: { duration: 1000 }
    }
  });
}

// Initial render + re-render on tab click for animation
document.addEventListener("DOMContentLoaded", renderYTDChart);
document.querySelector('button#ytd-tab').addEventListener('shown.bs.tab', renderYTDChart);
</script>


    <!-- ================= Monthly ================= -->
    <div class="tab-pane fade" id="monthly" role="tabpanel">
      <div class="card p-3 shadow-sm pill-card">
        <div class="d-flex justify-content-between align-items-center">
          <h4>üìÖ Monthly Totals</h4>
          <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart('monthlyChart')">‚¨áÔ∏è Download</button>
        </div>
        <canvas id="monthlyChart" height="80"></canvas>
        <div class="table-responsive table-scroll mt-3">
          <table class="table table-sm table-hover table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Indicator (Unit)</th>
                {% for m in monthly_labels %}<th class="text-end">{{ m }}</th>{% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in monthly_data %}
                <tr>
                  <td class="fw-medium">{{ row.indicator }}{% if row.unit %} ({{ row.unit }}){% endif %}</td>
                  {% for v in row.values %}<td class="text-end">{{ v|default:"-" }}</td>{% endfor %}
                </tr>
              {% empty %}
                <tr><td colspan="{{ monthly_labels|length|add:1 }}" class="text-center text-muted">No monthly data</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ================= Quarterly ================= -->
    <div class="tab-pane fade" id="quarterly" role="tabpanel">
      <div class="card p-3 shadow-sm pill-card">
        <div class="d-flex justify-content-between align-items-center">
          <h4>üìä Quarterly Totals</h4>
          <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart('quarterlyChart')">‚¨áÔ∏è Download</button>
        </div>
        <canvas id="quarterlyChart" height="80"></canvas>
        <div class="table-responsive table-scroll mt-3">
          <table class="table table-sm table-hover table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Indicator (Unit)</th>
                {% for q in quarterly_labels %}<th class="text-end">{{ q }}</th>{% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in quarterly_data %}
                <tr>
                  <td class="fw-medium">{{ row.indicator }}{% if row.unit %} ({{ row.unit }}){% endif %}</td>
                  {% for v in row.values %}<td class="text-end">{{ v|default:"-" }}</td>{% endfor %}
                </tr>
              {% empty %}
                <tr><td colspan="{{ quarterly_labels|length|add:1 }}" class="text-center text-muted">No quarterly data</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    
<!-- ================= Project Totals ================= -->
<div class="tab-pane fade" id="project" role="tabpanel">
  <div class="card p-3 shadow-sm pill-card">
    <div class="d-flex justify-content-between align-items-center">
      <h4>ü•ß Project Totals</h4>
      <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart('projectChart')">‚¨áÔ∏è Download</button>
    </div>

    <!-- Enlarged Pie Chart Container -->
    <div class="d-flex justify-content-center my-3">
      <canvas id="projectChart" width="600" height="600"></canvas>
    </div>

    {% if project_totals_summary %}
      <!-- Totals Table -->
      <div class="table-responsive table-scroll mt-3">
        <table class="table table-sm table-hover table-striped align-middle">
          <thead class="table-light">
            <tr><th>Project</th><th class="text-end">Total</th></tr>
          </thead>
          <tbody>
            {% for row in project_totals_summary %}
              <tr>
                <td class="fw-medium">{{ row.indicator__project__name }}</td>
                <td class="text-end">{{ row.total|default:0 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-light mt-2 mb-0">No project totals available for the selected year/unit.</div>
    {% endif %}

    {% if project_totals_chart %}
      <hr class="my-3">
      <h5 class="mb-3">üìã Per-Indicator Breakdown by Project</h5>
      {% for proj_name, items in project_totals_chart.items %}
        <div class="mb-4">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="text-primary mb-0">{{ proj_name }}</h6>
            <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart('projectIndicatorsChart{{ forloop.counter }}')">‚¨áÔ∏è Download</button>
          </div>
          <canvas id="projectIndicatorsChart{{ forloop.counter }}" height="180" class="mt-2"></canvas>
          <div class="table-responsive table-scroll mt-3">
            <table class="table table-sm table-hover table-striped align-middle">
              <thead class="table-light">
                <tr><th>Indicator</th><th class="text-end">Total</th></tr>
              </thead>
              <tbody>
                {% for row in items %}
                  <tr><td>{{ row.indicator }}</td><td class="text-end">{{ row.value }}</td></tr>
                {% empty %}
                  <tr><td colspan="2" class="text-center text-muted">No data</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
</div>


    <!-- ================= Project Trends ================= -->
    <div class="tab-pane fade" id="trends" role="tabpanel">
      <div class="card p-3 shadow-sm pill-card">
        <h4>üìå Project Trends</h4>
        {% if project_trends %}
          {% for project, series_list in project_trends.items %}
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="text-primary">{{ project }}</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart('trendChart{{ forloop.counter }}')">‚¨áÔ∏è Download</button>
              </div>
              <canvas id="trendChart{{ forloop.counter }}" height="70"></canvas>
              <div class="table-responsive table-scroll mt-3">
                <table class="table table-sm table-hover table-striped align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Indicator</th>
                      {% with first=series_list.0 %}
                        {% if first %}
                          {% for m in first.months %}<th class="text-end">{{ m }}</th>{% endfor %}
                        {% endif %}
                      {% endwith %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for s in series_list %}
                      <tr>
                        <td class="fw-medium">{{ s.indicator }}</td>
                        {% for v in s.values %}<td class="text-end">{{ v|default:"-" }}</td>{% endfor %}
                      </tr>
                    {% empty %}
                      <tr><td colspan="2" class="text-center text-muted">No data</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">No trend data available yet.</p>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<!-- ================= Scripts ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Add the DataLabels plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script>
function downloadChart(chartId){
  const canvas = document.getElementById(chartId);
  if(!canvas) return;
  const link = document.createElement("a");
  link.href = canvas.toDataURL("image/jpeg", 1.0);
  link.download = chartId + ".jpeg";
  link.click();
}




/* ---- YTD Charts ---- */
(function(){
  const el = document.getElementById("ytdChart");
  if(!el) return;

  const labels = [{% for row in ytd_totals %}{% if not forloop.last %}"{{ row.indicator__name|escapejs }}",{% endif %}{% endfor %}];
  const data = [{% for row in ytd_totals %}{% if not forloop.last %}{{ row.total|default:0|floatformat:"-2" }},{% endif %}{% endfor %}];

  // Generate dynamic colors
  const colors = labels.map((_, i) => {
    const palette = [
      "rgba(54,162,235,0.7)","rgba(255,99,132,0.7)","rgba(255,205,86,0.7)",
      "rgba(75,192,192,0.7)","rgba(153,102,255,0.7)","rgba(201,203,207,0.7)",
      "rgba(255,159,64,0.7)","rgba(100,181,246,0.7)"
    ];
    return palette[i % palette.length];
  });

  new Chart(el.getContext("2d"), {
    type: "bar",
    data: { labels, datasets: [{ label: "YTD", data: data, backgroundColor: colors }] },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index', intersect: false },
        datalabels: { anchor: 'end', align: 'end', color: '#000', font: { weight: 'bold' } }
      },
      scales: {
        y: { beginAtZero: true, suggestedMax: Math.max(...data) * 1.1, ticks: { stepSize: Math.max(...data)/5 || 1 } },
        x: { grid: { display: false } }
      },
      animation: { duration: 1000 }
    },
    plugins: [ChartDataLabels]
  });
})();

/* ---- Per-Indicator YTD ---- */
{% if ytd_indicator_totals %}
(function(){
  const el = document.getElementById("ytdIndicatorChart");
  if(!el) return;

  const labels = [{% for row in ytd_indicator_totals %}"{{ row.name|escapejs }}",{% endfor %}];
  const data = [{% for row in ytd_indicator_totals %}{{ row.value|default:0|floatformat:"-2" }},{% endfor %}];

  // Dynamic colors per bar
  const colors = labels.map((_, i) => {
    const palette = [
      "rgba(54,162,235,0.7)","rgba(255,99,132,0.7)","rgba(255,205,86,0.7)",
      "rgba(75,192,192,0.7)","rgba(153,102,255,0.7)","rgba(201,203,207,0.7)",
      "rgba(255,159,64,0.7)","rgba(100,181,246,0.7)"
    ];
    return palette[i % palette.length];
  });

  new Chart(el.getContext("2d"), {
    type: "bar",
    data: { labels, datasets: [{ label: "YTD by Indicator", data: data, backgroundColor: colors }] },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index', intersect: false },
        datalabels: { anchor: 'end', align: 'end', color: '#000', font: { weight: 'bold' } }
      },
      scales: {
        y: { beginAtZero: true, suggestedMax: Math.max(...data) * 1.1, ticks: { stepSize: Math.max(...data)/5 || 1 } },
        x: { grid: { display: false } }
      },
      animation: { duration: 1000 }
    },
    plugins: [ChartDataLabels]
  });
})();
{% endif %}



/* ---- Monthly & Quarterly Charts ---- */
(function(){
  const ctx = document.getElementById("monthlyChart").getContext("2d");
  const labels = [{% for m in monthly_labels %}"{{ m }}",{% endfor %}];
  const datasets = [{% for row in monthly_data %}{label:"{{ row.indicator|escapejs }}",data:[{% for v in row.values %}{{ v|default:0|floatformat:"-2" }},{% endfor %}],fill:false,borderWidth:2},{% endfor %}];
  new Chart(ctx,{type:"line",data:{labels,datasets},options:{responsive:true,interaction:{mode:'index',intersect:false}}});
})();
(function(){
  const ctx = document.getElementById("quarterlyChart").getContext("2d");
  const labels = [{% for q in quarterly_labels %}"{{ q }}",{% endfor %}];
  const datasets = [{% for row in quarterly_data %}{label:"{{ row.indicator|escapejs }}",data:[{% for v in row.values %}{{ v|default:0|floatformat:"-2" }},{% endfor %}],fill:false,borderWidth:2},{% endfor %}];
  new Chart(ctx,{type:"line",data:{labels,datasets},options:{responsive:true,interaction:{mode:'index',intersect:false}}});
})();


/* ---- Project Totals Pie Chart ---- */
(function(){
  const canvas = document.getElementById("projectChart");
  if(!canvas) return;

  const labels = [{% for lbl in project_totals_labels %}"{{ lbl|escapejs }}",{% endfor %}];
  const data = [{% for val in project_totals_data %}{{ val|default:0 }},{% endfor %}];

  if(labels.length && data.some(v => v > 0)) {
    new Chart(canvas.getContext("2d"), {
      type: "pie",
      data: {
        labels,
        datasets: [{
          data: data,
          backgroundColor: [
            "rgba(54,162,235,0.7)",
            "rgba(255,99,132,0.7)",
            "rgba(255,205,86,0.7)",
            "rgba(75,192,192,0.7)",
            "rgba(153,102,255,0.7)",
            "rgba(201,203,207,0.7)",
            "rgba(255,159,64,0.7)",
            "rgba(100,181,246,0.7)"
          ]
        }]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', align: 'center', labels: { boxWidth: 15, padding: 10, usePointStyle: true, pointStyle: 'circle' } },
          datalabels: {
            color: '#000',
            font: { weight: 'bold' },
            formatter: (value, ctx) => {
              let sum = ctx.chart._metasets[0].total;
              let percentage = ((value / sum) * 100).toFixed(1) + "%";
              return value + " (" + percentage + ")";
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  } else {
    canvas.style.display="none";
  }
})();

/* ---- Per-Project Indicator Charts ---- */
{% if project_totals_chart %}
{% for proj_name, items in project_totals_chart.items %}
(function(){
  const el = document.getElementById("projectIndicatorsChart{{ forloop.counter }}");
  if(!el) return;

  const labels = [{% for row in items %}"{{ row.indicator|escapejs }}",{% endfor %}];
  const data = [{% for row in items %}{{ row.value|default:0 }},{% endfor %}];

  const colors = labels.map((_, i) => {
    const palette = [
      "rgba(54,162,235,0.7)", "rgba(255,99,132,0.7)", "rgba(255,205,86,0.7)",
      "rgba(75,192,192,0.7)", "rgba(153,102,255,0.7)", "rgba(201,203,207,0.7)",
      "rgba(255,159,64,0.7)", "rgba(100,181,246,0.7)"
    ];
    return palette[i % palette.length];
  });

  new Chart(el.getContext("2d"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "{{ proj_name|escapejs }}",
        data: data,
        backgroundColor: colors,
        barPercentage: 0.5,
        categoryPercentage: 0.7
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end',
          align: 'end',
          color: '#000',
          font: { weight: 'bold' },
          formatter: (value) => value
        }
      },
      scales: { y: { beginAtZero: true } }
    },
    plugins: [ChartDataLabels]
  });
})();
{% endfor %}
{% endif %}






/* ---- Project Trends Charts ---- */
{% if project_trends %}
{% for project, series_list in project_trends.items %}
(function(){
  const el = document.getElementById("trendChart{{ forloop.counter }}");
  if(!el) return;
  const labels = [{% with first=series_list.0 %}{% if first %}{% for m in first.months %}"{{ m }}",{% endfor %}{% endif %}{% endwith %}];
  const datasets = [{% for s in series_list %}{label:"{{ s.indicator|escapejs }}",data:[{% for v in s.values %}{{ v|default:0|floatformat:"-2" }},{% endfor %}],fill:false,borderWidth:2,tension:0.3},{% endfor %}];
  new Chart(el.getContext("2d"),{type:"line",data:{labels,datasets},options:{responsive:true,interaction:{mode:'index',intersect:false}}});
})();
{% endfor %}
{% endif %}
</script>
{% endblock %}
