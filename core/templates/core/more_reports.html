{% extends 'core/base.html' %}
{% load custom_tags %}
{% load static %}

{% block title %}More Reports{% endblock %}

{% block content %}
<h2 class="mb-4">More Reports</h2>

<!-- Combined Year + Pivot Filters -->
<form method="get" id="pivotFilterForm" class="row g-3 mb-4">
  <div class="col-md-2">
    <label for="year" class="form-label">Year</label>
    <select name="year" id="year" class="form-select">
      {% for y in years %}
        <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <label for="unit" class="form-label">Unit</label>
    <select name="unit" id="unit" class="form-select">
      <option value="">All</option>
      {% for u in units %}
        <option value="{{ u }}" {% if selected_unit == u %}selected{% endif %}>{{ u }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <label for="project" class="form-label">Project</label>
    <select name="project" id="project" class="form-select">
      <option value="">All</option>
      {% for p in projects %}
        <option value="{{ p.id }}" {% if selected_project|default:'' == p.id|stringformat:"s" %}selected{% endif %}>{{ p.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <label for="indicator" class="form-label">Indicator</label>
    <select name="indicator" id="indicator" class="form-select">
      <option value="">All</option>
      {% for i in indicators %}
        <option value="{{ i.id }}" {% if selected_indicator|default:'' == i.id|stringformat:"s" %}selected{% endif %}>{{ i.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2 align-self-end">
    <a id="download-csv" href="{% url 'more_reports_export_csv' %}?year={{ selected_year }}&unit={{ selected_unit }}&project={{ selected_project }}&indicator={{ selected_indicator }}" class="btn btn-success">Download CSV</a>
  </div>
</form>

<!-- Tabs for Analytics -->
<ul class="nav nav-tabs mb-3" id="analyticsTabs" role="tablist">
  <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#distribution">Distribution</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#progress">Progress</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#cumulative">Cumulative</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#top-bottom">Top/Bottom</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#heatmap">Heatmap</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#correlation">Correlation</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#year-over-year">Year-over-Year</button></li>
</ul>

<div class="tab-content">
  <!-- Distribution -->
  <div class="tab-pane fade show active" id="distribution">
    <div class="chart-container mb-4" style="max-width:800px; height:400px; margin:auto;">
      <button class="btn btn-primary btn-sm mb-2" onclick="downloadChart('distributionChart', 'distribution.png')">Download Chart</button>
      <canvas id="distributionChart"></canvas>
    </div>
  </div>

  <!-- Progress -->
  <div class="tab-pane fade" id="progress">
    <div class="chart-container mb-4" style="max-width:800px; height:400px; margin:auto;">
      <button class="btn btn-primary btn-sm mb-2" onclick="downloadChart('progressChart', 'progress.png')">Download Chart</button>
      <canvas id="progressChart"></canvas>
      <p id="progressNoData" class="text-center mt-3 d-none">No data available.</p>
    </div>
  </div>

  <!-- Cumulative -->
  <div class="tab-pane fade" id="cumulative">
    <div class="chart-container mb-4" style="max-width:800px; height:400px; margin:auto;">
      <button class="btn btn-primary btn-sm mb-2" onclick="downloadChart('cumulativeChart', 'cumulative.png')">Download Chart</button>
      <canvas id="cumulativeChart"></canvas>
    </div>
  </div>

  <!-- Top/Bottom -->
  <div class="tab-pane fade" id="top-bottom">
    <div class="chart-container mb-4" style="max-width:800px; height:400px; margin:auto;">
      <button class="btn btn-primary btn-sm mb-2" onclick="downloadChart('rankingChart', 'ranking.png')">Download Chart</button>
      <canvas id="rankingChart"></canvas>
    </div>
  </div>

  <!-- Heatmap -->
  <div class="tab-pane fade" id="heatmap">
    <div class="chart-container mb-4" style="max-width:800px; height:400px; margin:auto;">
      <button class="btn btn-primary btn-sm mb-2" onclick="downloadChart('heatmapChart', 'heatmap.png')">Download Chart</button>
      <canvas id="heatmapChart"></canvas>
      <p id="heatmapNoData" class="text-center mt-3 d-none">No data available.</p>
    </div>
  </div>

  <!-- Correlation -->
  <div class="tab-pane fade" id="correlation">
    <div class="chart-container mb-4" style="max-width:800px; height:400px; margin:auto;">
      <button class="btn btn-primary btn-sm mb-2" onclick="downloadChart('correlationChart', 'correlation.png')">Download Chart</button>
      <canvas id="correlationChart"></canvas>
      <p id="correlationNoData" class="text-center mt-3 d-none">No data available.</p>
    </div>
  </div>

  <!-- Year-over-Year -->
  <div class="tab-pane fade" id="year-over-year">
    <div class="chart-container mb-4" style="max-width:800px; height:350px; margin:auto;">
      <button class="btn btn-primary btn-sm mb-2" onclick="downloadChart('yoyChart', 'yoy.png')">Download Chart</button>
      <canvas id="yoyChart"></canvas>
      <p id="yoyNoData" class="text-center mt-3 d-none">No data available.</p>
    </div>
  </div>
</div>

<div class="my-9"></div> <!-- Extra spacing before pivot table -->

<!-- Pivot Table -->
<h4 class="mt-5">Custom Reports (Pivot Table)</h4>
<table class="table table-bordered table-striped">
  <thead class="table-dark">
    <tr>
      <th>Indicator</th>
      <th>Unit</th>
      {% for m in month_headers %}<th>{{ m }}</th>{% endfor %}
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
    {% for row in pivot_data %}
      <tr>
        <td>{{ row.indicator }}</td>
        <td>{{ row.unit }}</td>
        {% for val in row.values %}<td>{{ val }}</td>{% endfor %}
        <td>{{ row.total }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="{{ 2|add:month_headers|length|add:1 }}" class="text-center">No data available.</td></tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th colspan="2">Column Totals</th>
      {% for m in month_headers %}<th>{{ column_totals|get_item:m }}</th>{% endfor %}
      <th>{{ grand_total }}</th>
    </tr>
  </tfoot>
</table>

<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.0/dist/chartjs-chart-matrix.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('pivotFilterForm');
  const selects = form.querySelectorAll('select');
  const csvLink = document.getElementById('download-csv');

  function updateCsvLink() {
    const params = new URLSearchParams({
      year: document.getElementById('year').value,
      unit: document.getElementById('unit').value,
      project: document.getElementById('project').value,
      indicator: document.getElementById('indicator').value
    });
    csvLink.href = `{% url 'more_reports_export_csv' %}?` + params.toString();
  }

  selects.forEach(select => select.addEventListener('change', () => { updateCsvLink(); form.submit(); }));
  updateCsvLink();

  function hasData(data) { return Array.isArray(data) && data.length > 0; }

  const distributionLabels = {{ indicator_distribution_labels|safe }};
  const distributionData = {{ indicator_distribution_data|safe }};
  const progressLabels = {{ indicator_progress_labels|safe }};
  const progressData = {{ indicator_progress_data|safe }};
  const cumulativeData = {{ cumulative_performance|safe }};
  const topLabels = {{ top_indicators_labels|safe }};
  const topData = {{ top_indicators_data|safe }};
  const heatmapData = {{ heatmap|safe }};
  const heatmapLabels = {{ indicator_labels|safe }};
  const correlationData = {{ correlation_data|safe }};
  const yoyLabels = {{ yoy_labels|safe }};
  const yoyData = {{ yoy_data_values|safe }};
  const monthLabels = {{ month_headers|safe }};

  const chartOptionsBase = {
    responsive:true,
    maintainAspectRatio:false,
    plugins: { 
      legend:{position:'bottom'}, 
      datalabels:{color:'#000', anchor:'end', align:'top'}, 
      background:{color:'#ffffff'} 
    }
  };

  window.downloadChart = function(chartId, filename) {
    const chart = Chart.getChart(chartId);
    if(chart){
      const originalBg = chart.options.plugins.background;
      chart.options.plugins.background = { color:'#ffffff' };
      chart.update();
      const link = document.createElement('a');
      link.href = chart.toBase64Image();
      link.download = filename;
      link.click();
      chart.options.plugins.background = originalBg;
      chart.update();
    }
  };

  let distributionChart, progressChart, cumulativeChart, rankingChart, heatmapChart, correlationChart, yoyChart;

  function renderCharts() {
    const colorPalette = ['#4e79a7','#f28e2b','#59a14f','#edc949','#e15759','#76b7b2','#af7aa1','#ff9da7'];

    // Distribution
    if(hasData(distributionData)){
      if(distributionChart) distributionChart.destroy();
      distributionChart = new Chart('distributionChart', {
        type:'doughnut',
        data:{labels:distributionLabels,datasets:[{data:distributionData,backgroundColor:colorPalette}]},
        options:{...chartOptionsBase, plugins:{...chartOptionsBase.plugins, tooltip:{enabled:false}} },
        plugins: [ChartDataLabels]
      });
    }

    // Progress
    if(hasData(progressData)){
      if(progressChart) progressChart.destroy();
      progressChart = new Chart('progressChart', {
        type:'bar',
        data:{
          labels: progressLabels,
          datasets:[{label:'Progress (%)',data:progressData,backgroundColor:progressData.map(v=>v>=75?'#59a14f':v>=50?'#edc949':'#e15759')}]
        },
        options:{...chartOptionsBase, scales:{y:{beginAtZero:true,max:100}} },
        plugins:[ChartDataLabels]
      });
    }

    // Cumulative
    if(hasData(cumulativeData)){
      if(cumulativeChart) cumulativeChart.destroy();
      cumulativeChart = new Chart('cumulativeChart',{
        type:'line',
        data:{labels:monthLabels,datasets:cumulativeData.map((item,i)=>({
          label:item.indicator,
          data:item.values,
          fill:true,
          borderColor:colorPalette[i%colorPalette.length],
          backgroundColor:colorPalette[i%colorPalette.length]+'33',
          tension:0.3
        }))},
        options:chartOptionsBase,
        plugins:[ChartDataLabels]
      });
    }

    // Top/Bottom
    if(hasData(topData)){
      if(rankingChart) rankingChart.destroy();
      rankingChart = new Chart('rankingChart',{
        type:'bar',
        data:{labels:topLabels,datasets:[{label:'Top Indicators',data:topData,backgroundColor:colorPalette.slice(0,topData.length)}]},
        options:chartOptionsBase,
        plugins:[ChartDataLabels]
      });
    }

    // Heatmap
    if(hasData(heatmapData)){
      if(heatmapChart) heatmapChart.destroy();
      heatmapChart = new Chart('heatmapChart',{
        type:'matrix',
        data:{datasets:[{
          label:'Heatmap',
          data:heatmapData.flatMap((row,i)=>row.map((v,j)=>({x:j,y:i,v:v}))),
          backgroundColor: ctx=>{
            const val = ctx.dataset.data[ctx.dataIndex].v;
            const max = Math.max(...ctx.dataset.data.map(d=>d.v));
            const intensity = max ? val/max : 0;
            return `rgba(54,162,235,${0.3 + 0.7*intensity})`;
          },
          width:({chart})=> chart.chartArea ? chart.chartArea.width/monthLabels.length : 0,
          height:({chart})=> chart.chartArea ? chart.chartArea.height/heatmapLabels.length : 0
        }]},
        options:{...chartOptionsBase, scales:{x:{type:'category',labels:monthLabels,offset:true,grid:{display:true}},y:{type:'category',labels:heatmapLabels,offset:true,grid:{display:true}}}, plugins:{legend:{display:false}, datalabels:{display:false}, background:{color:'#ffffff'}}},
        plugins:[ChartDataLabels]
      });
    }

    // Correlation
    if(hasData(correlationData)){
      if(correlationChart) correlationChart.destroy();
      correlationChart = new Chart('correlationChart',{
        type:'scatter',
        data:{datasets:[{label:'Correlation',data:correlationData,backgroundColor:'#4e79a7'}]},
        options:{...chartOptionsBase, scales:{x:{beginAtZero:true},y:{beginAtZero:true}} },
        plugins:[ChartDataLabels]
      });
    }

    // Year-over-Year
    if(hasData(yoyData)){
      if(yoyChart) yoyChart.destroy();
      yoyChart = new Chart('yoyChart',{
        type:'line',
        data:{labels:yoyLabels,datasets:[{label:'Total Value',data:yoyData,fill:false,borderColor:'#4e79a7',tension:0.3}]},
        options:chartOptionsBase,
        plugins:[ChartDataLabels]
      });
    }
  }

  renderCharts();

  // Re-render charts on tab switch
  const tabButtons = document.querySelectorAll('button[data-bs-toggle="tab"]');
  tabButtons.forEach(btn => btn.addEventListener('shown.bs.tab', ()=>{ renderCharts(); }));
});
</script>
{% endblock %}
