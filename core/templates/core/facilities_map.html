{% extends "core/base.html" %}
{% load static %}

{% block title %}Facilities Map{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="background-color:#f5f6fa;">
  <h2 class="text-primary mb-4">Project Facilities Map</h2>

  <!-- Year Filter -->
  <form method="get" id="yearFilterForm" class="mb-3">
    <label for="year" class="form-label fw-bold">Select Year:</label>
    <select name="year" id="year" class="form-select d-inline-block w-auto" onchange="this.form.submit()">
      {% for y in year_options %}
        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
  </form>

  <!-- Add/Edit Facility Form -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Add / Edit Facility</h5>
    </div>
    <div class="card-body">
      <form method="POST" id="facilityForm">
        {% csrf_token %}
        <input type="hidden" name="facility_id" id="facility_id" value="">
        <div class="row g-3">
          <div class="col-md-3">
            <label for="id_name" class="form-label">Facility Name</label>
            {{ form.name }}
          </div>
          <div class="col-md-2">
            <label for="id_latitude" class="form-label">Latitude</label>
            {{ form.latitude }}
          </div>
          <div class="col-md-2">
            <label for="id_longitude" class="form-label">Longitude</label>
            {{ form.longitude }}
          </div>
          <div class="col-md-3">
            <label for="projects" class="form-label">Link Projects</label>
            <select name="projects" id="projects" class="form-select" multiple>
              {% for project in active_projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
              {% endfor %}
            </select>
            <small class="text-muted">Hold Ctrl (Windows) or Cmd (Mac) to select multiple projects</small>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-success me-2" id="saveBtn">Save</button>
            <button type="button" class="btn btn-secondary" id="cancelEdit" style="display:none;">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Map Section -->
  <div class="card shadow-sm">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">Map of Project Facilities</h5>
    </div>
    <div class="card-body p-0">
      <div id="map" style="height: 700px; width: 100%;"></div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
var map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var facilities = {{ facilities_json|safe }};

// Teardrop SVG marker
function createMarker(color="#00bfff"){
    return L.divIcon({
        html: `<svg xmlns="http://www.w3.org/2000/svg" width="30" height="40" viewBox="0 0 24 24" fill="${color}">
                 <path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7z"/>
               </svg>`,
        className: "",
        iconSize: [30,40],
        iconAnchor: [15,40],
        popupAnchor: [0,-40]
    });
}

// Add markers
function addMarkers() {
    map.eachLayer(layer => {
        if(layer.options && layer.options.pane === "markerPane") map.removeLayer(layer);
    });

    facilities.forEach(fac => {
        var latlng = [parseFloat(fac.latitude), parseFloat(fac.longitude)];
        var marker = L.marker(latlng, {icon: createMarker(), draggable: true}).addTo(map);

        // Update form coordinates when dragging marker
        marker.on('dragend', function(e){
            var pos = e.target.getLatLng();
            document.getElementById("id_latitude").value = pos.lat.toFixed(6);
            document.getElementById("id_longitude").value = pos.lng.toFixed(6);
        });

        // Total people reached
        var totalPeople = fac.projects.reduce((sum,p)=>sum+(p.people_reached||0),0);

        // Facility label on top of marker
        marker.bindTooltip(`${fac.name} (${totalPeople})`, {
            permanent: true,
            direction: 'top',  
            offset: [0, -20],  
            className: 'facility-label'
        });

        // Popup with Edit/Delete
        marker.bindPopup(`
            <div class="d-flex flex-column">
                <button class="btn btn-sm btn-warning mb-1" onclick="editFacility(${fac.id}, '${fac.name}', ${latlng[0]}, ${latlng[1]}, [${fac.projects.map(p=>p.id).join(',')}])">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteFacility(${fac.id})">Delete</button>
            </div>
        `);
    });

    if(facilities.length > 0){
        var group = L.featureGroup(facilities.map(f => L.marker([f.latitude,f.longitude])));
        map.fitBounds(group.getBounds(), {padding:[50,50]});
    }
}

addMarkers();

// Edit facility function
function editFacility(id,name,lat,lng,projectIds){
    document.getElementById("facility_id").value = id;
    document.getElementById("id_name").value = name;
    document.getElementById("id_latitude").value = lat;
    document.getElementById("id_longitude").value = lng;
    document.getElementById("cancelEdit").style.display="inline-block";

    var select = document.getElementById("projects");
    Array.from(select.options).forEach(opt => opt.selected = projectIds.includes(parseInt(opt.value)));
    window.scrollTo({top:0, behavior:'smooth'});
}

// Cancel editing
document.getElementById("cancelEdit").addEventListener("click", function(){
    document.getElementById("facilityForm").reset();
    document.getElementById("facility_id").value = "";
    document.getElementById("cancelEdit").style.display="none";
    var select = document.getElementById("projects");
    Array.from(select.options).forEach(opt=>opt.selected=false);
});

// Form submission
document.getElementById("facilityForm").addEventListener("submit", function(e){
    e.preventDefault();
    var formData = new FormData(this);
    fetch("{% url 'facilities_map' %}",{
        method:"POST",
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
        body: formData
    }).then(r=>r.json()).then(data=>{
        if(data.success){
            facilities = data.facilities;
            addMarkers();
            document.getElementById("facilityForm").reset();
            document.getElementById("facility_id").value="";
            document.getElementById("cancelEdit").style.display="none";
        } else {
            alert("Error: "+JSON.stringify(data.errors));
        }
    }).catch(err=>{console.error(err); alert("Unexpected error.");});
});

// Delete facility
function deleteFacility(id){
    if(confirm("Are you sure you want to delete this facility?")){
        fetch(`/facilities/${id}/delete/`,{
            method:'POST',
            headers:{'X-CSRFToken':'{{ csrf_token }}'}
        }).then(r=>r.json()).then(data=>{
            if(data.success){
                facilities = facilities.filter(f=>f.id!==id);
                addMarkers();
            } else { alert("Failed to delete facility."); }
        }).catch(err=>{console.error(err); alert("Unexpected error.");});
    }
}
</script>

<style>
.facility-label {
    background: white;
    color: black;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: normal;
    font-size: 0.85rem;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    white-space: nowrap;
    text-align: center;
}
.leaflet-popup-content button { width: 70px; margin-right:5px; }
</style>
{% endblock %}
