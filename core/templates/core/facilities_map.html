{% extends "core/base.html" %}
{% load static %}

{% block title %}Facilities Map{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="background-color:#f5f6fa;">
  <h2 class="text-primary mb-4">Project Facilities Map</h2>

  <!-- ---------------- Year Filter ---------------- -->
  <form method="get" id="yearFilterForm" class="mb-3">
    <label for="year" class="form-label fw-bold">Select Year:</label>
    <select name="year" id="year" class="form-select d-inline-block w-auto" onchange="this.form.submit()">
      {% for y in year_options %}
        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
  </form>

  <!-- ---------------- Add / Edit Facility Form ---------------- -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Add / Edit Facility</h5>
    </div>
    <div class="card-body">
      <form method="POST" id="facilityForm">
        {% csrf_token %}
        <input type="hidden" name="facility_id" id="facility_id" value="">
        <div class="row g-3">
          <div class="col-md-3">
            <label for="id_name" class="form-label">Facility Name</label>
            {{ form.name }}
          </div>
          <div class="col-md-2">
            <label for="id_latitude" class="form-label">Latitude</label>
            {{ form.latitude }}
          </div>
          <div class="col-md-2">
            <label for="id_longitude" class="form-label">Longitude</label>
            {{ form.longitude }}
          </div>
          <div class="col-md-3">
            <label for="projects" class="form-label">Link Projects</label>
            <select name="projects" id="projects" class="form-select" multiple>
              {% for project in active_projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
              {% endfor %}
            </select>
            <small class="text-muted">Hold Ctrl (Windows) or Cmd (Mac) to select multiple projects</small>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-success me-2" id="saveBtn">Save</button>
            <button type="button" class="btn btn-secondary" id="cancelEdit" style="display:none;">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- ---------------- Map Section ---------------- -->
  <div class="card shadow-sm">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">Map of Project Facilities</h5>
    </div>
    <div class="card-body p-0">
      <div id="map" style="height: 700px; width: 100%;"></div>
    </div>
  </div>
</div>

<!-- ---------------- Leaflet & MarkerCluster CSS ---------------- -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<!-- ---------------- Leaflet & MarkerCluster JS ---------------- -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
var map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var markers = L.markerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 40,
    spiderfyOnMaxZoom: true,
    removeOutsideVisibleBounds: false,
    iconCreateFunction: function (cluster) {
        var children = cluster.getAllChildMarkers();
        var names = children.map(m => m.getTooltip().getContent().split("<br>")[0]);
        var label = names.slice(0, 3).join("<br>");
        if (names.length > 3) label += "<br><em>+" + (names.length - 3) + " more</em>";

        return L.divIcon({
            html: `<div class="cluster-tooltip">${label}</div>`,
            className: "custom-cluster",
            iconSize: [1, 1]
        });
    }
});

var facilities = {{ facilities_json|safe }};
var tooltips = [];

function addMarkers(){
    markers.clearLayers();
    tooltips = [];
    var coordsMap = {};

    facilities.forEach(function(fac){
        var lat = parseFloat(fac.latitude).toFixed(6);
        var lng = parseFloat(fac.longitude).toFixed(6);
        var key = lat + ',' + lng;
        if(!coordsMap[key]) coordsMap[key] = [];
        coordsMap[key].push(fac);
    });

    Object.keys(coordsMap).forEach(function(key){
        var group = coordsMap[key];
        var latlng = key.split(',').map(Number);

        var names = group.map(f => `<b>${f.name}</b> (${f.projects.map(p=>p.name).join(', ')})`).join('<br>');

        var circleMarker = L.circleMarker(latlng, {
            radius: 10,
            color: '#007bff',
            fillColor: '#007bff',
            fillOpacity: 0.6,
            weight: 2
        });

        var tooltip = circleMarker.bindTooltip(
          names,
          { permanent: true, direction: 'top', offset: [0,-15], className: 'facility-tooltip', opacity: 0.9 }
        );
        tooltips.push(tooltip);

        var first = group[0];
        circleMarker.bindPopup(`
          <div class="d-flex flex-column">
            <button class="btn btn-sm btn-warning mb-1" onclick="editFacility(${first.id}, '${first.name}', ${latlng[0]}, ${latlng[1]}, [${first.projects.map(p=>p.id).join(',')}])">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteFacility(${first.id})">Delete</button>
          </div>
        `);

        // Hover popup for "People reached"
        circleMarker.on('mouseover', function(){
            var totalPeople = group.reduce((sum, f) => {
                return sum + f.projects.reduce((s, p) => s + (p.people_reached || 0), 0);
            }, 0);

            this.bindTooltip(
              `<div class="people-popup">People reached: ${totalPeople}</div>`,
              { permanent: false, direction: 'right', offset: [10,0], className: 'people-tooltip' }
            ).openTooltip();
        });

        circleMarker.on('mouseout', function(){
            this.closeTooltip();
            this.unbindTooltip(); // prevent overwriting permanent tooltip
            this.bindTooltip(names, { permanent: true, direction: 'top', offset: [0,-15], className: 'facility-tooltip', opacity: 0.9 });
        });

        markers.addLayer(circleMarker);
    });

    map.addLayer(markers);
    if(facilities.length > 0){
        map.fitBounds(markers.getBounds(), {padding: [50,50]});
    }
}

addMarkers();

map.on('zoomend', function(){
    var zoom = map.getZoom();
    var scale = 1 + (zoom - map.getMinZoom())*0.05;
    tooltips.forEach(function(t){
      if(t._contentNode) t._contentNode.style.fontSize = (0.9 / scale) + 'rem';
    });
});
markers.on('clusterclick', function(e){ e.layer.spiderfy(); });

// ----------------- Edit / Cancel -----------------
function editFacility(id, name, lat, lng, projectIds){
    document.getElementById("facility_id").value = id;
    document.getElementById("id_name").value = name;
    document.getElementById("id_latitude").value = lat;
    document.getElementById("id_longitude").value = lng;
    document.getElementById("cancelEdit").style.display = "inline-block";

    var select = document.getElementById("projects");
    Array.from(select.options).forEach(opt => opt.selected = projectIds.includes(parseInt(opt.value)));
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.getElementById("cancelEdit").addEventListener("click", function(){
    document.getElementById("facilityForm").reset();
    document.getElementById("facility_id").value = "";
    document.getElementById("cancelEdit").style.display = "none";
    var select = document.getElementById("projects");
    Array.from(select.options).forEach(opt => opt.selected = false);
});

document.getElementById("facilityForm").addEventListener("submit", function(e){
    e.preventDefault();
    var formData = new FormData(this);

    fetch("{% url 'facilities_map' %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if(data.success){
            facilities = data.facilities;
            addMarkers();
            document.getElementById("facilityForm").reset();
            document.getElementById("facility_id").value = "";
            document.getElementById("cancelEdit").style.display = "none";
        } else {
            alert("Error: " + JSON.stringify(data.errors));
        }
    })
    .catch(err => {
        console.error("AJAX save error:", err);
        alert("An unexpected error occurred while saving.");
    });
});

function deleteFacility(id){
    if(confirm("Are you sure you want to delete this facility?")){
        fetch(`/facilities/${id}/delete/`, {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(response => response.json())
        .then(data => {
            if(data.success){
                facilities = facilities.filter(f => f.id !== id);
                addMarkers();
            } else {
                alert("Failed to delete facility.");
            }
        })
        .catch(err => {
            console.error("AJAX delete error:", err);
            alert("An unexpected error occurred while deleting.");
        });
    }
}
</script>

<style>
  .leaflet-popup-content button { width: 70px; margin-right: 5px; }

  .custom-cluster { background: transparent !important; border: none !important; }

  .cluster-tooltip {
      font-weight: bold;
      background-color: rgba(255,255,255,0.95);
      border: 1px solid #0056b3;
      border-radius: 6px;
      padding: 6px 10px;
      color: #0056b3;
      white-space: nowrap;
      font-size: 0.85rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      pointer-events: none;
  }

  .facility-tooltip {
      font-weight: bold;
      background-color: rgba(255,255,255,0.85);
      border: 1px solid #007bff;
      border-radius: 4px;
      padding: 4px 8px;
      color: #007bff;
      font-size: 0.9rem;
      transition: font-size 0.2s ease;
  }

  /* People reached popup styling */
  .people-tooltip {
      background: red !important;
      color: white !important;
      font-weight: bold;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.85rem;
  }
</style>
{% endblock %}
