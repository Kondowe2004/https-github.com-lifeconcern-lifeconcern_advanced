{% extends 'core/base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <h1 class="text-center mb-4" style="font-family:'QuickBooks', Arial, sans-serif;">{{ page_title }}</h1>

    <!-- Filters -->
    <div class="card p-3 mb-4">
        <form method="get" id="filterForm" class="row g-3 align-items-end">
            <div class="col-auto">
                <label class="form-label">Year</label>
                <input type="number" class="form-control" name="year" value="{{ year }}" min="2000" max="2100">
            </div>
            <div class="col-auto">
                <label class="form-label">Month From</label>
                <select class="form-select" name="month_from">
                    {% for num, name in month_choices %}
                        <option value="{{ num }}" {% if month_from == num %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label">Month To</label>
                <select class="form-select" name="month_to">
                    {% for num, name in month_choices %}
                        <option value="{{ num }}" {% if month_to == num %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label">Indicator</label>
                <select class="form-select" name="indicator">
                    <option value="">All</option>
                    {% for i in indicators %}
                        <option value="{{ i.id }}" {% if selected_indicator == i.id %}selected{% endif %}>{{ i.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label">Unit</label>
                <select class="form-select" name="unit">
                    <option value="">All</option>
                    {% for u in units %}
                        <option value="{{ u }}" {% if selected_unit == u %}selected{% endif %}>{{ u }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label">Project</label>
                <select class="form-select" name="project">
                    <option value="">All</option>
                    {% for p in projects %}
                        <option value="{{ p.id }}" {% if selected_project == p.id %}selected{% endif %}>{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">üîç Filter</button>
            </div>
        </form>
    </div>

    <!-- Charts Tabs -->
    <div class="card mb-3">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="chartTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="bar-tab" data-bs-toggle="tab" data-bs-target="#barChartTab" type="button" role="tab">Bar Chart</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="line-tab" data-bs-toggle="tab" data-bs-target="#lineChartTab" type="button" role="tab">Line Chart</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trend-tab" data-bs-toggle="tab" data-bs-target="#trendChartTab" type="button" role="tab">Trend Chart</button>
                </li>
            </ul>
        </div>
        <div class="tab-content p-3">
            <div class="tab-pane fade show active" id="barChartTab" role="tabpanel">
                {% if categories %}
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                    <button class="btn btn-sm btn-secondary mt-2" onclick="downloadChart('barChart')">‚¨á Download Chart</button>
                {% else %}
                    <p class="text-muted">‚ö† No data available for bar chart.</p>
                {% endif %}
            </div>
            <div class="tab-pane fade" id="lineChartTab" role="tabpanel">
                {% if categories %}
                    <div class="chart-container">
                        <canvas id="lineChart"></canvas>
                    </div>
                    <button class="btn btn-sm btn-secondary mt-2" onclick="downloadChart('lineChart')">‚¨á Download Chart</button>
                {% else %}
                    <p class="text-muted">‚ö† No data available for line chart.</p>
                {% endif %}
            </div>
            <div class="tab-pane fade" id="trendChartTab" role="tabpanel">
                {% if categories %}
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                    <button class="btn btn-sm btn-secondary mt-2" onclick="downloadChart('trendChart')">‚¨á Download Chart</button>
                {% else %}
                    <p class="text-muted">‚ö† No data available for trend chart.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Export Buttons -->
    <div class="mb-2">
        <a href="?{% for key, value in request.GET.items %}{% if key != 'export' %}{{ key }}={{ value }}&{% endif %}{% endfor %}export=excel" class="btn btn-sm btn-success">‚¨á Excel</a>
        <a href="?{% for key, value in request.GET.items %}{% if key != 'export' %}{{ key }}={{ value }}&{% endif %}{% endfor %}export=pdf" class="btn btn-sm btn-danger">‚¨á PDF</a>
    </div>

    <!-- Summary Table -->
    <div class="card p-3 mt-2">
        <h5 class="mb-3" style="font-family:'QuickBooks', Arial, sans-serif; font-weight:bold;">üìë Variance Summary Table</h5>
        <table id="varianceTable" class="display table table-hover table-sm" style="font-family:'QuickBooks', Arial, sans-serif; border:1px solid #ccc; border-collapse:collapse; width:100%;">
            <thead style="background-color:#2E7D32; color:white; font-weight:bold;">
                <tr>
                    <th>Year</th>
                    <th>Project</th>
                    <th>Indicator</th>
                    <th>Unit</th>
                    <th>Cumulative Actual</th>
                    <th>Current Month Actual</th>
                    <th>Total Actual</th>
                    <th>Target (Annual)</th>
                    <th>Variance</th>
                    <th>Progress (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for row in table_rows %}
                <tr style="background-color: {% cycle '#ffffff' '#f7f7f7' %};">
                    <td>{{ row.year }}</td>
                    <td>{{ row.project }}</td>
                    <td>{{ row.indicator }}</td>
                    <td>{{ row.unit }}</td>
                    <td>{{ row.cumulative }}</td>
                    <td>{{ row.actual }}</td>
                    <td>{{ row.total_actual }}</td>
                    <td>{{ row.target }}</td>
                    <td class="{% if row.variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if row.variance >= 0 %}‚úÖ{% else %}‚ùå{% endif %} {{ row.variance }}
                    </td>
                    <td>{{ row.progress|floatformat:1 }}%</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center text-muted" style="font-style:italic;">‚ö† No data available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script>
$(document).ready(function() {
  const categories = JSON.parse('{{ categories|escapejs }}');
  const chartData = JSON.parse('{{ chart_data|escapejs }}');

  const chartOptions = (title) => ({
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
      legend: { position:'top' },
      title: { display: true, text: title, font: { size: 16, weight: 'bold' } },
      datalabels: {
        display: (ctx) => ctx.dataset.label.toLowerCase().includes('actual'), // show only for actuals
        color: '#000',
        font: { weight: 'bold', size: 12 },
        anchor: 'end',
        align: 'top'
      }
    },
    scales: { y: { beginAtZero: true, ticks:{ precision:0 } } }
  });

  let charts = {};

  if (categories.length && chartData.length) {
    const coloredData = chartData.map(ds => {
        let color = ds.label.toLowerCase().includes('actual') ? '#007bff' : '#dc3545';
        return {...ds, backgroundColor: color, borderColor: color, fill:false};
    });

    // Bar Chart
    charts.bar = new Chart(document.getElementById('barChart'), {
      type: 'bar',
      data: { labels: categories, datasets: coloredData },
      options: chartOptions('Variance Report ‚Äì Bar Chart'),
      plugins: [ChartDataLabels]
    });

    // Line Chart
    const lineData = coloredData.map(ds => ({...ds, type:'line'}));
    charts.line = new Chart(document.getElementById('lineChart'), {
      type: 'line',
      data: { labels: categories, datasets: lineData },
      options: chartOptions('Variance Report ‚Äì Line Chart'),
      plugins: [ChartDataLabels]
    });

    // Trend Chart (cumulative with light fill for actuals)
    const trendData = coloredData.map(ds => {
      let cum = 0;
      const cumData = ds.data.map(v => (cum += v));
      return {
        ...ds,
        type:'line',
        data: cumData,
        borderDash: ds.label.toLowerCase().includes('target') ? [5,5] : [],
        backgroundColor: ds.label.toLowerCase().includes('actual') ? 'rgba(0,123,255,0.2)' : 'transparent',
        fill: ds.label.toLowerCase().includes('actual'),
      };
    });

    charts.trend = new Chart(document.getElementById('trendChart'), {
      type: 'line',
      data: { labels: categories, datasets: trendData },
      options: chartOptions('Variance Report ‚Äì Trend Chart'),
      plugins: [ChartDataLabels]
    });
  }

  $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
    const target = $(e.target).attr("data-bs-target");
    if (target === "#barChartTab" && charts.bar) charts.bar.resize();
    if (target === "#lineChartTab" && charts.line) charts.line.resize();
    if (target === "#trendChartTab" && charts.trend) charts.trend.resize();
  });
});

// Download chart as PNG with white background
function downloadChart(chartId) {
    const canvas = document.getElementById(chartId);
    const link = document.createElement('a');
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    const ctx = tempCanvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    ctx.drawImage(canvas, 0, 0);
    link.download = chartId + ".png";
    link.href = tempCanvas.toDataURL("image/png");
    link.click();
}
</script>

<style>
.chart-container { position: relative; height: 400px; width: 100%; background-color: #ffffff; }
#varianceTable { font-size: 0.85rem; border:1px solid #ccc; border-collapse:collapse; }
#varianceTable th, #varianceTable td { border:1px solid #ccc; }
.text-success { color: green; font-weight: bold; }
.text-danger { color: red; font-weight: bold; }
</style>
{% endblock %}
