{% extends "core/base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container-fluid py-4" style="background-color:#f5f6fa;">

  <!-- Page Header -->
  <div class="text-center mb-4" style="margin-top:-15px;">
    <h2 class="fw-bold text-primary" style="font-size: 2rem;">ðŸ“Š Monthly Performance Report</h2>
    <p class="text-secondary fst-italic" style="font-size: 0.95rem;">
      This dashboard presents each project's monthly performance trends â€” visualize progress, compare indicators, and download results for analysis.
    </p>
  </div>

  <!-- Filters -->
  <form id="filterForm" class="card p-3 shadow-sm bg-white rounded mb-4 border-0" method="get">
    <div class="d-flex flex-wrap gap-3 align-items-end justify-content-center">
      <div>
        <label class="form-label fw-semibold">Year</label>
        <select class="form-select" name="year" id="year">
          {% for y in years %}
          <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="form-label fw-semibold">Unit</label>
        <select class="form-select" name="unit" id="unit">
          <option value="">All Units</option>
          {% for u in units %}
          <option value="{{ u }}" {% if u == selected_unit %}selected{% endif %}>{{ u }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="form-label fw-semibold">Indicator</label>
        <select class="form-select" name="indicator" id="indicator">
          <option value="">All Indicators</option>
          {% for ind in indicators %}
          <option value="{{ ind.id }}" {% if ind.id == selected_indicator %}selected{% endif %}>{{ ind.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="form-label fw-semibold">From Month</label>
        <select class="form-select" name="month_from" id="month_from">
          {% for num, name in month_choices %}
          <option value="{{ num }}" {% if num == month_from %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="form-label fw-semibold">To Month</label>
        <select class="form-select" name="month_to" id="month_to">
          {% for num, name in month_choices %}
          <option value="{{ num }}" {% if num == month_to %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <button type="submit" class="btn btn-primary shadow-sm px-4">
          <i class="fas fa-filter me-1"></i> Apply Filters
        </button>
      </div>
    </div>
  </form>

  {% if monthly_trends|length == 0 %}
  <div class="alert alert-info text-center shadow-sm">No data available for the selected filters.</div>
  {% else %}

  <!-- Project Tabs -->
  <ul class="nav nav-tabs mb-3 justify-content-center" id="projectTabs" role="tablist">
    {% for proj in monthly_trends %}
    <li class="nav-item mx-1">
      <button class="nav-link project-tab {% if forloop.first %}active{% endif %}"
              data-bs-toggle="tab"
              data-bs-target="#proj{{ proj.project_id }}"
              data-color-index="{{ forloop.counter0 }}">
        {{ proj.project_name }}
      </button>
    </li>
    {% endfor %}
  </ul>

  <style>
    /* Tab Color Styles */
    .nav-tabs .nav-link {
      color: white !important;
      font-weight: 600;
      border-radius: 25px;
      padding: 8px 18px;
      border: none;
      margin: 3px;
      transition: all 0.3s ease;
    }

    .nav-tabs .nav-link.active {
      transform: scale(1.05);
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }

    /* Project tab dynamic colors */
    .project-tab[data-color-index="0"] { background: linear-gradient(45deg, #007bff, #00c6ff); }
    .project-tab[data-color-index="1"] { background: linear-gradient(45deg, #6f42c1, #b47cff); }
    .project-tab[data-color-index="2"] { background: linear-gradient(45deg, #28a745, #8fd19e); }
    .project-tab[data-color-index="3"] { background: linear-gradient(45deg, #fd7e14, #ffb347); }
    .project-tab[data-color-index="4"] { background: linear-gradient(45deg, #dc3545, #ff7b7b); }
    .project-tab[data-color-index="5"] { background: linear-gradient(45deg, #20c997, #5ee7b8); }
    .project-tab[data-color-index="6"] { background: linear-gradient(45deg, #6610f2, #a770ef); }
    .project-tab[data-color-index="7"] { background: linear-gradient(45deg, #17a2b8, #63e6e2); }
    .project-tab[data-color-index="8"] { background: linear-gradient(45deg, #ffc107, #ffe066); }

    .project-tab:hover {
      filter: brightness(1.1);
      transform: translateY(-2px);
    }
  </style>

  <!-- Project Charts -->
  <div class="tab-content">
    {% for proj in monthly_trends %}
    <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
         id="proj{{ proj.project_id }}" role="tabpanel">

      <!-- Chart Card -->
      <div class="card shadow-lg mb-4 p-3 rounded border-0 chart-wrapper"
           style="background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
                  opacity:0; transform: translateY(20px); transition: all 0.6s ease;">

        <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
          <h5 class="card-title text-primary fw-bold mb-0">
            <i class="fas fa-project-diagram me-2 text-secondary"></i> {{ proj.project_name }}
          </h5>
          <button class="btn btn-outline-primary btn-sm"
                  onclick="downloadChart('chartProj{{ proj.project_id }}', '{{ proj.project_name }}_{{ selected_year }}.png')">
            <i class="fas fa-download me-1"></i> Download Chart
          </button>
        </div>

        <div class="chart-container" style="min-height:450px;">
          <canvas id="chartProj{{ proj.project_id }}"></canvas>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const monthLabels = {{ month_headers|safe }};
    const monthlyTrends = {{ monthly_trends|safe }};
    const charts = {};

    const monthFrom = parseInt('{{ month_from|default:1 }}');
    const monthTo = parseInt('{{ month_to|default:12 }}');
    const visibleMonthLabels = monthLabels.slice(monthFrom - 1, monthTo);

    function getGradientColor(value, min, max) {
        if (min === max) return '#0d6efd';
        const ratio = (value - min) / (max - min);
        const r = Math.round(220 - (220 - 40) * ratio);
        const g = Math.round(53 + (200 - 53) * ratio);
        const b = Math.round(69 - 69 * ratio);
        return `rgb(${r},${g},${b})`;
    }

    function renderChart(proj) {
        if(charts[proj.project_id]) return;

        const values = proj.values.slice(monthFrom - 1, monthTo);
        const maxVal = Math.max(...values);
        const minVal = Math.min(...values);
        const bgColors = values.map(v => getGradientColor(v, minVal, maxVal));

        const ctx = document.getElementById('chartProj' + proj.project_id).getContext('2d');
        charts[proj.project_id] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: visibleMonthLabels,
                datasets: [{
                    label: proj.project_name,
                    data: values,
                    backgroundColor: bgColors,
                    borderColor: bgColors,
                    borderWidth: 1.2,
                    maxBarThickness: 55
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 1000, easing: 'easeOutBack' },
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: `Monthly Performance (${proj.indicator_summary})`,
                        font: { size: 16, weight: 'bold' },
                        color: '#0d6efd'
                    },
                    datalabels: {
                        anchor:'end', align:'top', color:'#333', font:{weight:'bold', size:11}
                    }
                },
                scales: {
                    y: { beginAtZero:true, title:{display:true,text:'Value'} },
                    x: { title:{display:true,text:'Month'} }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function animateChartWrapper(tabContent) {
        const wrapper = tabContent.querySelector('.chart-wrapper');
        if(wrapper) {
            wrapper.style.opacity = 0;
            wrapper.style.transform = 'translateY(20px)';
            setTimeout(() => {
                wrapper.style.opacity = 1;
                wrapper.style.transform = 'translateY(0)';
            }, 50);
        }
    }

    if(monthlyTrends.length > 0){
        renderChart(monthlyTrends[0]);
        animateChartWrapper(document.querySelector('.tab-pane.show.active'));
    }

    const tabButtons = document.querySelectorAll('#projectTabs button');
    tabButtons.forEach((btn, idx) => {
        btn.addEventListener('shown.bs.tab', function(){
            renderChart(monthlyTrends[idx]);
            const tabContent = document.querySelector(btn.dataset.bsTarget);
            animateChartWrapper(tabContent);
        });
    });

    window.downloadChart = function(chartId, filename) {
        const chart = Chart.getChart(chartId);
        if(chart){
            const link = document.createElement('a');
            link.href = chart.toBase64Image();
            link.download = filename;
            link.click();
        }
    }

    const form = document.getElementById('filterForm');
    form.querySelectorAll('select').forEach(sel => {
        sel.addEventListener('change', () => form.submit());
    });
});
</script>
{% endblock %}
