{% extends 'core/base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block title %}Edit Indicator Targets{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="card shadow-sm rounded-3 p-4">
    <h2 class="mb-3">Edit Targets for Indicator: <strong>{{ indicator.name }}</strong></h2>
    <p class="text-muted">Project: {{ indicator.project.name }}</p>

    <form method="post" id="indicatorTargetsForm">
      {% csrf_token %}
      {{ formset.management_form }}

      <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th style="width: 20%;">Year</th>
            <th style="width: 60%;">Target Value</th>
            <th style="width: 20%;">Delete?</th>
          </tr>
        </thead>
        <tbody>
          {% for form in formset %}
            <tr>
              <td>
                {% if form.instance.pk %}
                  {% render_field form.year class="form-select" %}
                {% else %}
                  <select name="{{ form.prefix }}-year" class="form-select">
                    {% for y in year_range %}
                      <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                  </select>
                {% endif %}
              </td>
              <td>
                {% render_field form.value class="form-control target-input" type="number" step="1" %}
                <div class="invalid-feedback">Please enter a whole number only.</div>
              </td>
              <td class="text-center">
                {% if form.instance.pk %}
                  {% render_field form.DELETE class="form-check-input" %}
                {% else %}
                  {{ form.DELETE }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="d-flex justify-content-start gap-2 mt-3">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-2"></i>Save Targets
        </button>
        <a href="{% url 'project_kpis' indicator.project.id %}" class="btn btn-secondary">
          Cancel
        </a>
      </div>
    </form>
  </div>
</div>

<!-- JavaScript: Whole-Number Validation -->
<script>
document.addEventListener('input', function(e) {
  if (e.target.classList.contains('target-input')) {
    const val = e.target.value.trim();
    if (val === "" || /^\d+$/.test(val)) {
      e.target.classList.remove('is-invalid');
      e.target.classList.add('valid-input');
    } else {
      e.target.classList.add('is-invalid');
      e.target.classList.remove('valid-input');
    }
  }
});

document.getElementById('indicatorTargetsForm').addEventListener('submit', function(e) {
  let invalid = false;
  const inputs = document.querySelectorAll('.target-input');
  inputs.forEach(input => {
    const val = input.value.trim();
    if (val !== "" && !/^\d+$/.test(val)) {
      input.classList.add('is-invalid');
      invalid = true;
    }
  });
  if (invalid) {
    e.preventDefault();
    alert('Please correct non-whole-number target values before saving.');
  }
});
</script>

<style>
/* Table and card styling */
table input, table select { width: 100%; }
.table-hover tbody tr:hover { background-color: rgba(0, 123, 255, 0.05); }
.card h2 { font-size: 1.5rem; font-weight: 600; }

/* Checkbox alignment */
.form-check-input { width: 1.25em; height: 1.25em; margin: 0 auto; }

/* Valid target input highlight */
.valid-input {
  background-color: #e9f7ef !important;
  border-color: #198754 !important;
}

/* Invalid target input highlight */
.target-input.is-invalid {
  background-color: #ffe6e6 !important;
  border-color: #dc3545 !important;
}

/* Remove number input spinner arrows */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
input[type=number] { -moz-appearance: textfield; }
</style>
{% endblock %}
