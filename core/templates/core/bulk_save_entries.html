{% extends "core/base.html" %}
{% load widget_tweaks %}
{% block title %}Bulk Save KPI Entries{% endblock %}

{% block content %}
<div class="card shadow-lg border-0">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h3 class="mb-0">ðŸ“¥ Bulk Save KPI Entries</h3>
    <small class="text-light">Enter values for indicators below</small>
  </div>
  <div class="card-body">
    <form method="post" id="bulkEntriesForm">
      {% csrf_token %}

      <!-- Year & Month -->
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label for="year" class="form-label fw-semibold">Year</label>
          <input type="number" id="year" name="year" value="{{ year }}" required 
                 class="form-control shadow-sm" step="1" min="2000" max="2100">
        </div>
        <div class="col-md-6">
          <label for="month" class="form-label fw-semibold">Month</label>
          <input type="number" id="month" name="month" value="{{ month }}" min="1" max="12" required 
                 class="form-control shadow-sm" step="1">
        </div>
      </div>

      <hr>

      <!-- ðŸ”Ž Search Bar -->
      <div class="mb-3">
        <input type="text" id="searchInput" class="form-control shadow-sm" 
               placeholder="ðŸ”Ž Search indicators..." onkeyup="filterIndicators()">
      </div>

      <!-- Indicators -->
      <div class="row g-3" id="indicatorList">
        {% for indicator in indicators %}
          <div class="col-md-6 indicator-item">
            <label for="indicator_{{ indicator.id }}" class="form-label fw-semibold">
              {{ indicator.name }}
            </label>
            <input type="number" id="indicator_{{ indicator.id }}" 
                   name="indicator_{{ indicator.id }}" 
                   class="form-control shadow-sm"
                   step="1" min="0"
                   placeholder="Enter value for {{ indicator.name }}">
            <div class="invalid-feedback">Please enter a valid whole number.</div>
          </div>
        {% endfor %}
      </div>

      <!-- Save Button -->
      <div class="mt-4 text-center">
        <button type="submit" class="btn btn-success btn-lg px-5 shadow-sm">
          ðŸ’¾ Save Entries
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ðŸ”Ž JavaScript: Search & Whole-Number Validation -->
<script>
function filterIndicators() {
  let input = document.getElementById("searchInput");
  let filter = input.value.toLowerCase();
  let items = document.getElementsByClassName("indicator-item");

  for (let i = 0; i < items.length; i++) {
    let label = items[i].getElementsByTagName("label")[0];
    let textValue = label.textContent || label.innerText;
    items[i].style.display = textValue.toLowerCase().indexOf(filter) > -1 ? "" : "none";
  }
}

// âœ… Highlight filled inputs & check whole numbers
const form = document.getElementById('bulkEntriesForm');

function isWholeNumber(val) {
  return /^\d+$/.test(val);
}

form.addEventListener('input', function(e) {
  if (e.target.tagName === 'INPUT' && e.target.id.startsWith('indicator_')) {
    const val = e.target.value.trim();
    if (val === "") {
      e.target.classList.remove('filled', 'is-invalid');
    } else if (!isWholeNumber(val)) {
      e.target.classList.add('is-invalid');
      e.target.classList.remove('filled');
    } else {
      e.target.classList.remove('is-invalid');
      e.target.classList.add('filled');
    }
  }
});

form.addEventListener('submit', function(e) {
  let invalid = false;
  const inputs = form.querySelectorAll('input[id^="indicator_"]');
  inputs.forEach(input => {
    const val = input.value.trim();
    if (val !== "" && !isWholeNumber(val)) {
      input.classList.add('is-invalid');
      invalid = true;
    }
  });
  if (invalid) {
    e.preventDefault();
    alert('Please correct non-whole-number values before saving.');
  }
});
</script>

<!-- Extra Styling -->
<style>
  .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 6px rgba(13,110,253,0.25);
  }
  .indicator-item input.filled {
    background-color: #e9f7ef !important;
    border-color: #198754 !important;
  }
  .indicator-item input.is-invalid {
    background-color: #ffe6e6 !important;
    border-color: #dc3545 !important;
  }
  /* Remove spinner arrows in number inputs */
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
  }
  input[type=number] {
      -moz-appearance: textfield;
  }
</style>
{% endblock %}
