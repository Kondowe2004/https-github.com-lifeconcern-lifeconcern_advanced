<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Life Concern{% endblock %}</title>
  {% load widget_tweaks %}
  {% load static %}
  <link rel="stylesheet" href="{% static 'styles.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <meta name="theme-color" content="#007bff">

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f4f6f9;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* ----------------- Sidebar DHIS2 Style ----------------- */
    .sidebar {
      width: 220px;
      background-color: #1e3a5f;
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 1.5rem 0.5rem;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      transition: width 0.3s ease;
      position: relative;
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .sidebar .brand {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 2rem;
      text-align: center;
      color: #fff;
      transition: opacity 0.3s ease;
    }

    .sidebar.collapsed .brand {
      opacity: 0;
    }

    .sidebar .nav {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .sidebar .nav a,
    .sidebar .nav form button {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 1rem;
      transition: background 0.2s ease, transform 0.1s ease, filter 0.3s ease;
      white-space: nowrap;
    }

    .sidebar .nav a svg,
    .sidebar .nav button svg {
      width: 28px;
      height: 28px;
      flex-shrink: 0;
      transition: transform 0.3s ease, filter 0.3s ease;
    }

    /* DHIS2-style glow on hover */
    .sidebar .nav a:hover svg,
    .sidebar .nav button:hover svg {
      transform: scale(1.15);
      filter: drop-shadow(0 0 6px currentColor);
    }

    .sidebar .nav a.active svg {
      transform: scale(1.15);
      filter: drop-shadow(0 0 6px currentColor);
    }

    .sidebar .nav a.active,
    .sidebar .nav a:hover,
    .sidebar .nav button:hover {
      background-color: rgba(255,255,255,0.15);
      transform: translateX(3px);
    }

    .sidebar .nav button {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      width: 100%;
      text-align: left;
      padding: 12px 16px;
    }

    /* Sidebar hide/show button */
    #sidebar-toggle {
      position: absolute;
      top: 10px;
      right: -15px;
      width: 30px;
      height: 30px;
      background: #007bff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #fff;
      font-weight: bold;
      z-index: 10;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    /* Main content */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      transition: margin-left 0.3s ease;
    }

    .sidebar.collapsed ~ .content {
      margin-left: 70px;
    }

    .topbar {
      background: #fff;
      padding: 0.8rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #dee2e6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .topbar h1 {
      font-size: 1.25rem;
      margin: 0;
      font-weight: 600;
      color: #333;
    }
    .topbar .user-info {
      font-size: 0.9rem;
      color: #555;
    }

    .page-body {
      flex: 1;
      padding: 2rem;
      background: #f4f6f9;
    }

    .card {
      border-radius: 14px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      background: #fff;
      margin-bottom: 1.5rem;
      border: none;
    }
    .card-header {
      font-weight: 600;
      font-size: 1rem;
      background: transparent;
      border-bottom: 1px solid #eee;
    }

    #install-btn {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 9999;
      display: none;
    }
  </style>
</head>
<body>
  <div class="layout">
    {% if request.resolver_match.url_name != "login" %}
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="brand">Life Concern</div>
        <div id="sidebar-toggle">&#9776;</div>
        <nav class="nav">
          <!-- Dashboard -->
          <a href="{% url 'dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#fbbc05"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z"/></svg>
            <span>Dashboard</span>
          </a>
          <!-- Projects -->
          <a href="{% url 'projects' %}" class="{% if request.resolver_match.url_name == 'projects' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#34a853"><path d="M10 4H2v16h20V8H12l-2-4z"/></svg>
            <span>Projects</span>
          </a>
          <!-- Reports -->
          <a href="{% url 'reports' %}" class="{% if request.resolver_match.url_name == 'reports' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#4285f4"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm4-8h2V3H7v6zm0 4h2v-2H7v2zm4 0h2v-4h-2v4zm0 4h2v-2h-2v2zm4-8h2V7h-2v6zm0 4h2v-2h-2v2zm4-12H5c-1.1 0-2 .9-2 2v16l4-4h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
            <span>Reports</span>
          </a>
          <!-- More Reports -->
          <a href="{% url 'more_reports' %}" class="{% if request.resolver_match.url_name == 'more_reports' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#ea4335"><path d="M14 2H6c-1.1 0-2 .9-2 2v16h16V8l-6-6z"/></svg>
            <span>More Reports</span>
          </a>
          <!-- Data Story -->
          <a href="{% url 'data_story' %}" class="{% if request.resolver_match.url_name == 'data_story' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#ff6d01"><path d="M19 3H5c-1.1 0-2 .9-2 2v16l4-4h12c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
            <span>Data Story</span>
          </a>
          <!-- Profile -->
          <a href="{% url 'profile' %}" class="{% if request.resolver_match.url_name == 'profile' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#9c27b0"><path d="M12 12c2.7 0 4.8-2.2 4.8-4.8S14.7 2.4 12 2.4 7.2 4.6 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/></svg>
            <span>Profile</span>
          </a>
          <!-- Admin -->
          <a href="{% url 'admin:index' %}" target="_blank">
            <svg viewBox="0 0 24 24" fill="#00bcd4"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z"/></svg>
            <span>Admin</span>
          </a>
          <!-- Website -->
          <a href="https://www.licomw.org" target="_blank">
            <svg viewBox="0 0 24 24" fill="#ff5722"><path d="M12 4a8 8 0 108 8 8 8 0 00-8-8zm0 14.4a6.4 6.4 0 116.4-6.4 6.4 6.4 0 01-6.4 6.4z"/></svg>
            <span>Website</span>
          </a>
          <!-- Facebook -->
          <a href="https://web.facebook.com/LifeConcernMalawi" target="_blank">
            <svg viewBox="0 0 24 24" fill="#4267b2"><path d="M22 12c0-5.5-4.5-10-10-10S2 6.5 2 12c0 4.9 3.5 8.9 8 9.8v-6.9H8v-2.9h2V9.5c0-2 1.2-3.1 3-3.1.9 0 1.8.1 1.8.1v2h-1c-1 0-1.3.6-1.3 1.2v1.5h2.3l-.3 2.9h-2V22c4.5-.9 8-4.9 8-9.8z"/></svg>
            <span>Facebook</span>
          </a>
          <!-- Logout -->
          <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit">
              <svg viewBox="0 0 24 24" fill="#d32f2f"><path d="M16 13v-2H7V7l-5 5 5 5v-4h9z"/></svg>
              <span>Logout</span>
            </button>
          </form>
        </nav>
      </aside>
    {% endif %}

    <!-- Main Content -->
    <div class="content" id="main-content">
      {% if request.resolver_match.url_name != "login" %}
        <div class="topbar">
          <h1>{% block page_title %}{% endblock %}</h1>
          <div class="user-info">{{ request.user.username }}</div>
        </div>
      {% endif %}

      <main class="page-body">
        {% if messages %}
          <div class="container mb-3">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags|default:"info" }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
        <div class="container-fluid">{% block content %}{% endblock %}</div>
      </main>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Sidebar toggle -->
  <script>
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
    });
  </script>

  <!-- Chart Download Helper -->
  <script>
    function downloadChart(chartId, format = "png") {
      const chartCanvas = document.getElementById(chartId);
      if (!chartCanvas) return;
      const link = document.createElement("a");
      link.download = chartId + "." + format;
      link.href = chartCanvas.toDataURL("image/" + format);
      link.click();
    }
  </script>

  <!-- PWA Service Worker & Install Button -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register("/service-worker.js")
          .then(reg => console.log('Service Worker registered', reg))
          .catch(err => console.log('Service Worker registration failed', err));
      });
    }

    let deferredPrompt;
    const installBtn = document.createElement('button');
    installBtn.id = 'install-btn';
    installBtn.textContent = 'Install Dashboard';
    installBtn.classList.add('btn', 'btn-primary');
    installBtn.style.display = 'none';
    document.body.appendChild(installBtn);

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      installBtn.style.display = 'none';
      deferredPrompt.prompt();
      const choiceResult = await deferredPrompt.userChoice;
      console.log('User choice:', choiceResult.outcome);
      deferredPrompt = null;
    });
  </script>

  <!-- Auto-Logout on Browser/Tab Close -->
  <script>
    window.addEventListener('beforeunload', function() {
      navigator.sendBeacon("{% url 'logout' %}");
    });
  </script>

  {% block extra_scripts %}{% endblock %}
</body>
</html>
