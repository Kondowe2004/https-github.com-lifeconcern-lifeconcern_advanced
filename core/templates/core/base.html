<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Life Concern{% endblock %}</title>
  {% load widget_tweaks %}
  {% load static %}
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{% static 'favicon.png' %}">
  <link rel="shortcut icon" type="image/png" href="{% static 'favicon.png' %}">
  <link rel="stylesheet" href="{% static 'styles.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <meta name="theme-color" content="#007bff">

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f4f6f9;
      margin: 0 !important;
      padding: 0 !important;
    }

    .layout {
      display: flex;
      min-height: 100vh;
      transition: all 0.3s ease;
    }

    /* ----------------- Sidebar ----------------- */
    .sidebar {
      width: 180px;
      background-color: #1e3a5f;
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 0.6rem 0.4rem;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      transition: width 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .sidebar.collapsed {
      width: 65px;
    }

    .sidebar .brand {
      font-size: 1.1rem;
      font-weight: 700;
      margin: 0.4rem auto 0.7rem;
      text-align: center;
      color: #fff;
      white-space: nowrap;
      transition: opacity 0.3s ease;
    }

    .sidebar.collapsed .brand {
      opacity: 0;
    }

    .sidebar .nav {
      display: flex;
      flex-direction: column;
      width: 100%;
      transition: all 0.3s ease;
    }

    .sidebar .nav a,
    .sidebar .nav form button {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 2px;
      font-size: 0.88rem;
      transition: background 0.2s ease, transform 0.1s ease, filter 0.3s ease, padding 0.3s ease;
      white-space: nowrap;
      overflow: hidden;
    }

    .sidebar.collapsed .nav a span,
    .sidebar.collapsed .nav button span {
      display: none;
    }

    .sidebar .nav a svg,
    .sidebar .nav button svg {
      width: 17px;
      height: 17px;
      flex-shrink: 0;
      transition: transform 0.3s ease, filter 0.3s ease;
    }

    .sidebar .nav a:hover svg,
    .sidebar .nav button:hover svg {
      transform: scale(1.15);
      filter: drop-shadow(0 0 4px currentColor);
    }

    .sidebar .nav a.active,
    .sidebar .nav a:hover,
    .sidebar .nav button:hover {
      background-color: rgba(255,255,255,0.15);
      transform: translateX(2px);
    }

    .sidebar .nav form {
      margin-top: 0.8rem;
      border-top: 1px solid rgba(255,255,255,0.2);
      padding-top: 0.6rem;
    }

    .sidebar .nav button {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      width: 100%;
      text-align: left;
      padding: 7px 10px;
    }

    /* Username display below logout with icon */
    .sidebar .username {
      margin-top: 0.25rem;
      padding: 4px 10px;
      font-size: 0.85rem;
      color: #ffd700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      word-break: break-word;
      white-space: normal;
      transition: transform 0.2s ease;
    }
    .sidebar .username svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      transition: transform 0.2s ease;
    }
    .sidebar .username:hover svg {
      transform: scale(1.2);
    }
    .sidebar.collapsed .username {
      display: none;
    }

    /* Sidebar toggle button */
    #sidebar-toggle {
      position: absolute;
      top: 5px;
      right: -14px;
      width: 26px;
      height: 26px;
      background: #007bff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #fff;
      font-weight: bold;
      z-index: 10;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

    /* Main content auto-resizes */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      transition: margin-left 0.3s ease;
      width: calc(100% - 180px);
    }

    .sidebar.collapsed ~ .content {
      width: calc(100% - 65px);
    }

    /* Reduced padding for tighter layout */
    .page-body {
      flex: 1;
      padding: 1rem 0.8rem;
      background: #f4f6f9;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .container-fluid {
      padding-left: 0.6rem;
      padding-right: 0.6rem;
    }

    .card {
      border-radius: 14px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      background: #fff;
      margin-bottom: 1.5rem;
      border: none;
    }

    .card-header {
      font-weight: 600;
      font-size: 1rem;
      background: transparent;
      border-bottom: 1px solid #eee;
    }

    footer {
      text-align: center;
      padding: 0.8rem;
      font-size: 0.85rem;
      color: #777;
      background: #fff;
      border-top: 1px solid #ddd;
      margin-top: 1rem;
    }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        height: 100%;
        z-index: 1000;
      }
      .content {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="layout">
    {% if request.resolver_match.url_name != "login" %}
      <aside class="sidebar" id="sidebar">
        <div class="brand">Life Concern</div>
        <div id="sidebar-toggle">&#9776;</div>
        <nav class="nav">
          <!-- ================= Sidebar Links ================= -->
          <a href="{% url 'dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#fbbc05"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z"/></svg>
            <span>Dashboard</span>
          </a>
          <a href="{% url 'projects' %}" class="{% if request.resolver_match.url_name == 'projects' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#34a853"><path d="M10 4H2v16h20V8H12l-2-4z"/></svg>
            <span>Projects</span>
          </a>
          <a href="{% url 'reports' %}" class="{% if request.resolver_match.url_name == 'reports' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#4285f4"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm4-8h2V3H7v6zm0 4h2v-2H7v2zm4 0h2v-4h-2v4zm0 4h2v-2h-2v2zm4-8h2V7h-2v6zm0 4h2v-2h-2v2zm4-12H5c-1.1 0-2 .9-2 2v16l4-4h14c1.1 0 2-.9 2-2V5z"/></svg>
            <span>Reports</span>
          </a>
          <a href="{% url 'monthly_performance_report' %}" class="{% if request.resolver_match.url_name == 'monthly_performance_report' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#ff9800"><path d="M3 3h18v18H3V3zm2 2v14h14V5H5zm2 2h10v2H7V7zm0 4h10v2H7v-2zm0 4h6v2H7v-2z"/></svg>
            <span>Monthly Performance</span>
          </a>
          <a href="{% url 'more_reports' %}" class="{% if request.resolver_match.url_name == 'more_reports' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#ea4335"><path d="M14 2H6c-1.1 0-2 .9-2 2v16h16V8l-6-6z"/></svg>
            <span>More Reports</span>
          </a>
          <a href="{% url 'data_story' %}" class="{% if request.resolver_match.url_name == 'data_story' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#ff6d01"><path d="M19 3H5c-1.1 0-2 .9-2 2v16l4-4h12c1.1 0 2-.9 2-2V5z"/></svg>
            <span>Data Story</span>
          </a>
          <a href="{% url 'actual_vs_variance' %}" class="{% if request.resolver_match.url_name == 'actual_vs_variance' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#198754"><path d="M3 3v18h18V3H3zm16 16H5V5h14v14zM6 12h4v4H6v-4zm8-8h4v12h-4V4z"/></svg>
            <span>Actual vs Variance</span>
          </a>
          <a href="{% url 'gender_insights' %}" class="{% if request.resolver_match.url_name == 'gender_insights' %}active{% endif %}">
              <svg viewBox="0 0 24 24" fill="#198754">
                  <path d="M14 2h4v4h-2V4h-2V2zm-4 4a6 6 0 100 12 6 6 0 000-12zm0 10a4 4 0 110-8 4 4 0 010 8zm-4 2H2v-4h2v2h2v2zm16 0h-4v-2h2v-2h2v4z"/>
              </svg>
              <span>Gender Insights</span>
          </a>
          <a href="{% url 'facilities_map' %}" class="{% if request.resolver_match.url_name == 'facilities_map' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#2196f3"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>
            <span>Maps</span>
          </a>
          <a href="{% url 'donors_list' %}" class="{% if request.resolver_match.url_name == 'donors_list' or request.resolver_match.url_name == 'donor_detail' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#2196f3"><path d="M21 11h-6.31l.95-4.57.03-.32a1 1 0 00-1-1h-4v2h2.42l-.57 2.72L11 16H5v2h6c.47 0 .86-.33.97-.78L13.58 12H21v-1z"/></svg>
            <span>Donors</span>
          </a>
          <a href="{% url 'profile' %}" class="{% if request.resolver_match.url_name == 'profile' %}active{% endif %}">
            <svg viewBox="0 0 24 24" fill="#9c27b0"><path d="M12 12c2.7 0 4.8-2.2 4.8-4.8S14.7 2.4 12 2.4 7.2 4.6 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/></svg>
            <span>Profile</span>
          </a>
          <a href="{% url 'admin:index' %}" target="_blank">
            <svg viewBox="0 0 24 24" fill="#00bcd4"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z"/></svg>
            <span>Admin</span>
          </a>

          <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit">
              <svg viewBox="0 0 24 24" fill="#d32f2f"><path d="M16 13v-2H7V7l-5 5 5 5v-4h9z"/></svg>
              <span>Logout</span>
            </button>
          </form>

          <!-- Username with icon -->
          <div class="username">
            <svg viewBox="0 0 24 24" fill="#ffd700">
              <path d="M12 12c2.7 0 4.8-2.2 4.8-4.8S14.7 2.4 12 2.4 7.2 4.6 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/>
            </svg>
            {{ request.user.username }}
          </div>
        </nav>
      </aside>
    {% endif %}

    <div class="content" id="main-content">
      <main class="page-body">
        {% if messages %}
          <div class="container mb-3">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags|default:"info" }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
        <div class="container-fluid">
          {% block content %}{% endblock %}
        </div>
        <footer>
          &copy; {% now "Y" %} Life Concern | All rights reserved | Developed by Nelson Kondowe.
        </footer>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
    });
  </script>

  <script>
    function downloadChart(chartId, format = "png") {
      const chartCanvas = document.getElementById(chartId);
      if (!chartCanvas) return;
      const link = document.createElement("a");
      link.download = chartId + "." + format;
      link.href = chartCanvas.toDataURL("image/" + format);
      link.click();
    }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register("/service-worker.js")
          .then(reg => console.log('Service Worker registered', reg))
          .catch(err => console.log('Service Worker registration failed', err));
      });
    }
  </script>

  <script>
    window.addEventListener('beforeunload', function() {
      navigator.sendBeacon("{% url 'logout' %}");
    });
  </script>

  {% block extra_scripts %}{% endblock %}
</body>
</html>
